---
title: "Лабораторная работа 3. Применение кластерного анализа. Метод PLS"
author: "Сокуров"
date: "28.10.2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Задание

Целью данной работы является формирование у магистрантов знаний в области статистики и навыков программирования на языке программирования R при решении задач кластеризации в биомедицине.

Изучите Статью (<http://mixomics.org/case-studies/splsda-srbct-case-study/>).

Выполните расчеты по Статье (<http://mixomics.org/case-studies/splsda-srbct-case-study/>) и проведите перекрестную проверку (cross validation) на языке программирования R.

Выполните аналогичные расчеты и предсказание (predict) для аналогичного по структуре набора данных выбранного самостоятельно (https://www.kaggle.com, datasetsearch) на языке программирования R.

Можно выбрать следующий набор данных: https://archive.ics.uci.edu/dataset/186/wine+quality.

Материалы к ознакомлению: установка библиотеки mixOmix, mixOmics vignette.

Отчет сформируйте в RStudio в pdf-формате и прикрепите в качестве ответа.

# Ход работы

## 1. Выполнение расчётов по статье.

### 1.1 Получение и анализ данных

Необходимый датасет для работы находится в пакете mixOmics. Было выполнено подключение данного пакета, а также установлено зерно случайной генерации для воспроизводимости результатов:

```{r results = FALSE, message=FALSE, warning=FALSE}
library(mixOmics) # подключаем его
set.seed(5249) # для воспроизводимости результатов
```

Затем выполнили анализ датасета SRBCT (Маленькие круглые голубоклеточные опухоли). Для этого информацию об экспрессии генов поместили в матрицу X, а классы опухоли — в матрицу Y. Проверили размерность X и распределение классов в Y:

```{r}
data(srbct) # Получаем данные small round bull cell tumour
X <- srbct$gene # используем уровни экспрессии генов как матрицу X
Y <- srbct$class # используем классы как матрицу Y

dim(X) # проверяем размерность датафрейма X
summary(Y) # проверяем распределение классов
```

Видно, что распределение классов неравномерно: наименьшее количество элементов одного классов — 8, наибольшее количество элементов другого класса — 23, разница почти в 3 раза.

Как и в большинстве случаев при разработке моделей, хорошим первым шагом является изучение данных для определения основных источников вариаций. В данной статье был использован метод главных компонент (PCA):

```{r}
# Применяем метод главных компонент, 10 компонент, центрируем и нормируем
pca.srbct = pca(X, ncomp = 10, center = TRUE, scale = TRUE) 
plot(pca.srbct)  # столбчатый график собственных значений
```
Как видно из графика, первых двух компонент будет достаточно для того, чтобы объяснить существенную долю дисперсии данных. Затем, чтобы обнаружить источники вариаций было выполнено проецировании классов на эти компоненты:

```{r}
plotIndiv(pca.srbct, group = srbct$class, ind.names = FALSE,  
          legend = TRUE, title = 'PCA on SRBCT, comp 1 - 2') 
```

Исходя из рисунка видно, что различные типы опухолей не разделяются и не группируются по двум основным компонентам данных. Существуют кластеры, но они не объясняются меткой класса. Таким образом, можно сделать вывод, что основной источник различий не связан с типом опухоли. 

### 2.1 Первоначальная модель sPLS-DA

Используем метод sPLS-DA, чтобы создать компоненты, которые максимально дифференцируют группы.

```{r}
srbct.splsda <- splsda(X, Y, ncomp = 10)  # устанавливаем ncomp равным 10 для сравнения с PCA в дальнейшем
```

Далее были спроецированы классы на первые две компоненты sPLS-DA с доверительными эллипсами:

```{r}
plotIndiv(srbct.splsda , 
          group = srbct$class, ind.names = FALSE,  
          ellipse = TRUE, # доверительный эллипс 0.95
          legend = TRUE, title = 'PLSDA с доверительными эллипсами')
```

Как видно, разделение на классы произведено намного лучше. После чего этот график был выведен с границами классов:

```{r}
# использование max.dist для измерения чтобы сформировать границы классов
background = background.predict(srbct.splsda, comp.predicted=2, dist = "max.dist")

# график классов проецированных на первые две компоненты sPLS-DA
plotIndiv(srbct.splsda,
          group = srbct$class, ind.names = FALSE,
          background = background, 
          legend = TRUE, title = "PLSDA с границами классов")
```

### 2.2 Настройка sPLS-DA

### 2.2.1 Выбор количества комопнент

Количество используемых компонент является важным решением и определяется производительностью модели PLS-DA, то есть ее способностью правильно классифицировать новые образцы. Именно для этого используется функция `perf()`. Данная функция использует кросс-валидацию внутри себя. На основе выходных данных этой функции можно определить оптимальное количество используемых компонентов.

Здесь используется Кросс-валидация с разделением данных на 3 части и 10 повторениями. Однако, для датасетов с множеством выборок (экспериментов) рекомендуется разделение на 10 частей. Разделение на 3-5 частей подходит для меньших датасетов. А те, у которых количество выборок минимально, должны использовать Leave-On-Out (LOO) валидацию. Причём, рекомендуется использовать 50-100 повторений, чтобы снизить долю влияния от случайно деления датасета на каждом шаге. 

Далее, для выяснения нужного количества компонент, был построен график зависимости ошибки классификации от количества компонент. Причём, 